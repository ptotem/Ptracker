<div class="block">
  <div class="content">
    <h2 class="title">
      <% if params[:project_id] %>
          Tasks in <%= Project.find(params[:project_id]).name %>
      <% elsif params[:user_id] %>
          Tasks for <%= User.find(params[:user_id]).name %>
      <% else %>
          All Tasks
      <% end %>
    </h2>

    <div class="inner">
      <table class="table table-striped">
        <tbody>
        <% @tasks.each do |task| %>
            <tr class="draggable" id="<%= task.id %>">
              <td style="font-size: 24px;padding:10px;"><%= best_in_place task, :name, :type => :textarea %></td>
              <% if params[:project_id] %>
                  <td><%= task.uname %></td>
              <% else %>
                  <td><%= task.project.name %></td>
                  <td><%= task.uname %></td>
              <% end %>
              <td><%= task.complete ? "Complete" :"" %></td>
              <td><%= best_in_place_if (current_user.role=="Projects"), task, :start_date, :type => :date %></td>
              <td class="last">
                <div class="btn-group pull-right">
                  <a class="btn btn-primary" data-backdrop="static" data-toggle="modal" href="#splitter_<%= task.id %>">Split</a>
                  <%= link_to "Mark Complete", task, :class => "btn btn-success" %>
                  <%= link_to "Delete", task_path(task), :method => :delete, :confirm => "Are you sure?", :class => "btn btn-danger" %>
                </div>

                <div class="modal hide fade" id="splitter_<%= task.id %>">
                  <div class="modal-header">
                    <a class="close" data-dismiss="modal">Ã—</a>

                    <h3>Split the Task</h3>
                  </div>
                  <div class="modal-body">
                    <h1>Into how many pieces</h1>
                    <% (1..7).each do |i| %>
                        <%= link_to i, split_task_path(task, i), :class => "btn btn-inverse" %>
                    <% end %>
                  </div>
                  <div class="modal-footer">
                    <a href="#" class="btn btn-danger" data-dismiss="modal">Close</a>
                  </div>
                </div>
              </td>
            </tr>
        <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<br/>

<%= link_to 'New Task', new_task_path %>

<script type="text/javascript">
    $(function () {
        var c = {};

        $("tr.draggable").draggable({
            helper:"clone",
            start:function (event, ui) {
                c.tr = this;
                c.helper = ui.helper;
            }
        });


        $("tr.draggable").droppable({
            drop:function (event, ui) {
                var inventor = ui.draggable.text();
                $this=$(this);
                var data = {source:[], target:[]};
                data["source"].push(ui.draggable.attr('id'));
                data["target"].push($(this).attr('id'));
                $.ajax({
                    url:"<%= combine_tasks_path %>",
                    type:"post",
                    data:JSON.stringify(data),
                    contentType:"application/json",
                    success:function (returning_data) {
                        $(c.tr).remove();
                        $(c.helper).remove();
                        $this.find("td:first").find(".best_in_place").html(returning_data);
                    }})
            }
        });
    });
</script>